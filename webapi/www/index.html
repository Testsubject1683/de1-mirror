<html>

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js"
    integrity="sha256-TQq84xX6vkwR0Qs1qH5ADkP+MvH0W+9E7TdHJsoIQiM=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.js"
    integrity="sha256-8zyeSXm+yTvzUN1VgAOinFgaVFEFTyYzWShOy9w7WoQ=" crossorigin="anonymous"></script>
  <script>

    var address = location.origin;
    window.addEventListener("load", onLoad);


    function onLoad() {
      updateTimer();
      loadShots();
      initChart();
    }

    function changeState(newState) {
      var oReq = new XMLHttpRequest();
      oReq.open("GET", address + "/api/state/" + newState);
      oReq.send();
    }

    var timer;
    function updateTimer() {
      if (document.getElementById("refresh").checked) {
        timer = setInterval(getState, 5000);
      } else {
        clearInterval(timer);
      }
    }

    function getState() {
      var oReq = new XMLHttpRequest();
      oReq.addEventListener("load", function (event) {
        if (oReq.status >= 200 && oReq.status < 300) {
          writeToScreen(oReq.responseText);
        } else {
          console.warn(oReq.statusText, oReq.responseText);
        }
      });
      oReq.open("GET", address + "/api/status");
      oReq.send();
    }

    function writeToScreen(message) {
      var output = document.getElementById("output");
      var pre = document.createElement("p");
      pre.style.wordWrap = "break-word";
      pre.innerHTML = message;

      while (output.firstChild) {
        output.firstChild.remove();
      }
      output.appendChild(pre);
    }

    function loadShots() {
      var x = document.getElementById("shots");
      fetch(address + "/api/history/").then(r => r.json())
        .then(j => j.sort().reverse().map((e) => {
          var option = document.createElement("option");
          option.text = e;
          x.add(option);
        })).then(e => {
          x.options[1].selected = true;
          x.onchange();
        });

    }

    function loadSelectedShot() {
      let selected = document.getElementById("shots").value;
      if (!selected) {
        window.chart.data.datasets.forEach(ds => ds.data = null);
        window.chart.update();
      } else {
        fetch(address + "/api/history/" + selected).then(r => r.text())
          .then(t => {
            var time = extractArray(t, "espresso_elapsed");
            var pressure = extractArray(t, "espresso_pressure");
            var time_pressure = new Array();
            for (var i = 0; i < time.length; i++) {
              time_pressure.push({ x: time[i], y: pressure[i] });
            }
            var pressureGoal = extractArray(t, "espresso_pressure_goal");
            var time_pressureGoal = new Array();
            for (var i = 0; i < time.length; i++) {
              let goal = pressureGoal[i];

              time_pressureGoal.push({ x: time[i], y: goal >= 0 ? goal : NaN });
            }

            var flow = extractArray(t, "espresso_flow");
            var time_flow = new Array();
            for (var i = 0; i < time.length; i++) {
              time_flow.push({ x: time[i], y: flow[i] });
            }
            var flowGoal = extractArray(t, "espresso_flow_goal");
            var time_flowGoal = new Array();
            for (var i = 0; i < time.length; i++) {
              let goal = flowGoal[i];
              time_flowGoal.push({ x: time[i], y: goal >= 0 ? goal : NaN });
            }

            var temperature = extractArray(t, "espresso_temperature_basket");
            var time_temperature = new Array();
            for (var i = 0; i < time.length; i++) {
              time_temperature.push({ x: time[i], y: temperature[i] / 10 });
            }
            var temperatureGoal = extractArray(t, "espresso_temperature_goal");
            var time_temperatureGoal = new Array();
            for (var i = 0; i < time.length; i++) {
              time_temperatureGoal.push({ x: time[i], y: temperatureGoal[i] / 10 });
            }

            var profile = extractString(t, "profile");
            var duration = time[time.length];


            //update chart
            window.chart.data.datasets.forEach(dataset => {
              switch (dataset.label) {
                case 'pressure':
                  dataset.data = time_pressure;
                  break;
                case 'pressure-goal':
                  dataset.data = time_pressureGoal;
                  break;
                case 'flow':
                  dataset.data = time_flow;
                  break;
                case 'flow-goal':
                  dataset.data = time_flowGoal;
                  break;
                case 'temperature':
                  dataset.data = time_temperature;
                  break;
                case 'temperature-goal':
                  dataset.data = time_temperatureGoal;
                  break;
              }
            });
            window.chart.update();
          });
      }
    }

    function extractArray(shotfile, key) {
      return extractString(shotfile, key).split(' ');
    }

    function extractString(shotfile, key) {
      var match = shotfile.match(key + " \{(.+)\}");
      if (match != null) {
        return match[1];
      } else {
        return null;
      }
    }

    function initChart() {
      var ctx = document.getElementById("myChart").getContext("2d");
      var borderDash = [10, 10];
      var pointRadius = 2;
      window.chart = new Chart(ctx, {
        type: 'scatter',

        // The data for our dataset
        data: {
          //labels: [1, 2, 4, 5, 6, 7, 8],
          datasets: [{
            showLine: true,
            fill: false,
            label: 'pressure',
            borderColor: 'rgb(124,252,0)',
            pointRadius: pointRadius
          }, {
            showLine: true,
            fill: false,
            label: 'pressure-goal',
            borderColor: 'rgb(124,252,0)',
            borderDash: borderDash,
            pointRadius: 0
          }, {
            showLine: true,
            fill: false,
            label: 'flow',
            borderColor: 'rgb(0,191,255)',
            pointRadius: pointRadius
          }, {
            showLine: true,
            fill: false,
            label: 'flow-goal',
            borderColor: 'rgb(0,191,255)',
            borderDash: borderDash,
            pointRadius: 0
          }, {
            showLine: true,
            fill: false,
            label: 'temperature',
            borderColor: 'rgb(220,20,60)',
            pointRadius: pointRadius
          }, {
            showLine: true,
            fill: false,
            label: 'temperature-goal',
            borderColor: 'rgb(220,20,60)',
            borderDash: borderDash,
            pointRadius: 0
          }]
        },

        options: {
          tooltips: {
            mode: 'x',
          },
          scales: {
            xAxes: [{
              type: 'linear',
              position: 'bottom'
            }]
          }
        }
      });
    }
  </script>
</head>

<body>

  <input type="button" onclick="changeState('start')" value="start" />
  <input type="button" onclick="changeState('sleep')" value="sleep" />
  <input type="button" onclick="getState()" value="get state" />
  <input type="checkbox" id="refresh" onclick="updateTimer()" /> <label for="refresh">refresh</label>
  <div id="output"></div>
  <br />
  <select id="shots" onchange="loadSelectedShot()">
    <option />
  </select>
  <br />
  <div style="max-width: 100%;">
    <canvas id="myChart"></canvas>
  </div>
</body>

</html>